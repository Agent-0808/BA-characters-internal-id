name: æ—¥å¸¸æ£€æµ‹æ›´æ–°

# è§¦å‘æœºåˆ¶é…ç½®
on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 3ç‚¹ (UTCæ—¶é—´ 19ç‚¹)
  schedule:
    - cron: '*/10 * * * *'
      timezone: 'Asia/Shanghai'
  
  # å…è®¸åœ¨ç½‘é¡µç«¯æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  workflow_dispatch:
  
  # å½“ä»£ç æ¨é€åˆ° workflow-test åˆ†æ”¯æ—¶è§¦å‘æµ‹è¯•ï¼ˆè°ƒè¯•ç”¨ï¼‰
  push:
    branches:
      - workflow-test

# æƒé™é…ç½®ï¼šå…è®¸ Action è¯»å†™ä»“åº“å†…å®¹ä»¥è¿›è¡Œæ¨é€å’Œå‘å¸ƒ Release
permissions:
  contents: write

# ç¯å¢ƒå˜é‡ï¼šä»£ç ç‰ˆæœ¬å·
env:
  CODE_VERSION: v3.0

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºå½“å‰åˆ†æ”¯ï¼ˆmainï¼‰çš„ä»£ç 
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      # é…ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # å®‰è£…ä¾èµ–åº“
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install httpx

      # å°è¯•ä» data åˆ†æ”¯æ‹‰å–ä¸Šæ¬¡çš„ç¼“å­˜æ–‡ä»¶
      # ä»è¿œç¨‹çš„ data åˆ†æ”¯å°† cache æ–‡ä»¶å¤¹æ¢å¤åˆ°å½“å‰å·¥ä½œç›®å½•ï¼Œå®ç°å¢é‡æ›´æ–°
      - name: ä» data åˆ†æ”¯æ¢å¤ç¼“å­˜
        run: |
          echo "æ­£åœ¨æ£€æŸ¥è¿œç¨‹ data åˆ†æ”¯..."
          # å°è¯•è·å– origin/data çš„ä¿¡æ¯ï¼Œå¦‚æœåˆ†æ”¯ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰åˆ™å¿½ç•¥é”™è¯¯
          git fetch origin data || echo "æœªæ‰¾åˆ° data åˆ†æ”¯ã€‚"
          
          # æ£€æŸ¥è¿œç¨‹ data åˆ†æ”¯é‡Œæ˜¯å¦æœ‰ cache ç›®å½•
          if git ls-tree -d origin/data:cache >/dev/null 2>&1; then
            echo "å‘ç°ç¼“å­˜ï¼Œæ­£åœ¨æ¢å¤..."
            # å°† origin/data åˆ†æ”¯ä¸‹çš„ cache ç›®å½•æ£€å‡ºåˆ°å½“å‰å·¥ä½œåŒº
            git checkout origin/data -- cache/
          else
            echo "æœªå‘ç°ç¼“å­˜ï¼Œå°†å»ºç«‹æ–°ç¼“å­˜ç›®å½•ã€‚"
            mkdir -p cache
          fi

      # è®°å½•è¿è¡Œå‰çš„çŠ¶æ€æ–‡ä»¶æŒ‡çº¹
      # å› ä¸º cache ç›®å½•è¢« gitignore å¿½ç•¥ï¼Œæ— æ³•ç”¨ git status æ£€æµ‹å˜åŒ–
      # æˆ‘ä»¬é€šè¿‡è®¡ç®— state.json çš„ MD5 å“ˆå¸Œå€¼æ¥åˆ¤æ–­ Python è„šæœ¬æ˜¯å¦è¿›è¡Œäº†æ›´æ–°
      - name: è®°å½•è¿è¡Œå‰çŠ¶æ€
        id: pre_state
        run: |
          if [ -f "cache/state.json" ]; then
            # è®¡ç®—æ–‡ä»¶å“ˆå¸Œå¹¶ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
            md5sum cache/state.json | awk '{print $1}' > pre_hash.txt
          else
            echo "empty" > pre_hash.txt
          fi
          echo "è¿è¡Œå‰ Hash: $(cat pre_hash.txt)"

      # è·å–å½“å‰æ—¥æœŸ
      - name: è·å–å½“å‰æ—¥æœŸ
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # è¿è¡Œä¸»ç¨‹åº
      - name: è¿è¡Œçˆ¬è™«è„šæœ¬
        run: python main.py -m 1 -d 5

      # æ£€æµ‹æ•°æ®æ˜¯å¦å‘ç”Ÿå˜åŒ–
      # å¯¹æ¯”è¿è¡Œå‰åçš„ state.json å“ˆå¸Œå€¼
      - name: æ£€æµ‹æ˜¯å¦æœ‰æ•°æ®æ›´æ–°
        id: check_changes
        run: |
          # è®¡ç®—è¿è¡Œåçš„å“ˆå¸Œ
          if [ -f "cache/state.json" ]; then
            md5sum cache/state.json | awk '{print $1}' > post_hash.txt
          else
            echo "empty" > post_hash.txt
          fi
          
          echo "è¿è¡Œå‰ Hash: $(cat pre_hash.txt)"
          echo "è¿è¡Œå Hash: $(cat post_hash.txt)"
          
          # æ¯”è¾ƒä¸¤ä¸ªå“ˆå¸Œæ–‡ä»¶ï¼Œ-s è¡¨ç¤ºé™é»˜æ¨¡å¼
          if cmp -s pre_hash.txt post_hash.txt; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "ğŸ’¤ çŠ¶æ€æ–‡ä»¶æœªå‘ç”Ÿå˜åŒ–ï¼Œæ— éœ€æ›´æ–°ã€‚"
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°æ–°æ•°æ®ï¼å‡†å¤‡æäº¤å’Œå‘å¸ƒã€‚"
          fi

      # å‡†å¤‡è¦å‘å¸ƒåˆ° data åˆ†æ”¯çš„æ–‡ä»¶
      # ä»…å½“æ£€æµ‹åˆ°å˜åŒ–æ—¶è¿è¡Œ
      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          mkdir -p deployment_folder
          
          if [ -d "output" ]; then
            cp -r output deployment_folder/
          fi
          
          if [ -d "cache" ]; then
            cp -r cache deployment_folder/
          fi
          
          echo "ä»¥ä¸‹æ–‡ä»¶å°†è¢«æ¨é€åˆ° data åˆ†æ”¯ï¼š"
          ls -R deployment_folder

      # å°†æ•°æ®å’Œç¼“å­˜æ¨é€åˆ° data åˆ†æ”¯
      # ä»…å½“æ£€æµ‹åˆ°å˜åŒ–æ—¶è¿è¡Œ
      - name: å°†æ•°æ®å’Œç¼“å­˜æ¨é€åˆ° data åˆ†æ”¯
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deployment_folder
          publish_branch: data
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "Auto-update: ${{ env.CODE_VERSION }}-${{ steps.date.outputs.date }}"
          keep_files: false
          enable_jekyll: true

      # åˆ›å»º Release å‘å¸ƒ
      # ä»…å½“æ£€æµ‹åˆ°å˜åŒ–æ—¶è¿è¡Œ
      - name: åˆ›å»º Release ç‰ˆæœ¬
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.CODE_VERSION }}-${{ steps.date.outputs.date }}
          name: ${{ env.CODE_VERSION }} Auto Update ${{ steps.date.outputs.date }}
          body: |
            æ£€æµ‹åˆ°æ•°æ®å˜åŠ¨ï¼Œå·²ç”Ÿæˆæ–°çš„æ–‡ä»¶å’Œç¼“å­˜ã€‚
            
            - **ä»£ç ç‰ˆæœ¬**: ${{ env.CODE_VERSION }}
            - **æ›´æ–°æ—¥æœŸ**: ${{ steps.date.outputs.date }}
            - **æ•°æ®åˆ†æ”¯**: [æŸ¥çœ‹ data åˆ†æ”¯](https://github.com/${{ github.repository }}/tree/data)
            
          files: |
            output/students_data.csv
            output/skipped_ids.csv
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}