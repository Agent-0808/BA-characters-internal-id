name: Daily Data Update

# è§¦å‘æœºåˆ¶
on:
  # 1. å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 3ç‚¹ (UTC 19ç‚¹)
  schedule:
    - cron: '0 19 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ç½‘é¡µç«¯ç‚¹å‡»æŒ‰é’®è¿è¡Œ
  workflow_dispatch:
  
  # 3. æ¨é€è§¦å‘ï¼šä»…å½“æ¨é€åˆ° workflow-test åˆ†æ”¯æ—¶è§¦å‘ (æ–¹ä¾¿ä½ ç°åœ¨æµ‹è¯•)
  push:
    branches:
      - workflow-test

# æƒé™é…ç½®ï¼šå…è®¸å†™å…¥ä»£ç å’Œåˆ›å»º Release
permissions:
  contents: write

# ç¯å¢ƒå˜é‡ï¼šç‰ˆæœ¬å·é…ç½®
env:
  BASE_VERSION: v3.0

jobs:
  update-and-release:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # å‡†å¤‡ Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx

      # è¿è¡Œçˆ¬è™«
      - name: Run scraper
        run: python main.py

      # æ£€æµ‹æ˜¯å¦æœ‰æ–°æ•°æ®æˆ–ç¼“å­˜å˜åŒ–
      - name: Check for changes
        id: check_changes
        run: |
          # ä½¿ç”¨ git status æŸ¥çœ‹æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹æˆ–æ–°å»º
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "âœ… Detected changes in data or cache."
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "ğŸ’¤ No changes detected."
          fi

      # ç”Ÿæˆæ—¥æœŸåç¼€ (ä»…å½“æœ‰å˜åŠ¨æ—¶)
      - name: Get current date
        if: steps.check_changes.outputs.changes_detected == 'true'
        id: date
        # ç”Ÿæˆæ ¼å¼å¦‚ 2025-08-08
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # æäº¤å¹¶æ¨é€åˆ° workflow-test åˆ†æ”¯ (ä¿å­˜ç¼“å­˜)
      - name: Commit and Push changes
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¼ºåˆ¶æ·»åŠ ç¼“å­˜ç›®å½•å’Œæ•°æ®æ–‡ä»¶
          git add cache/ output/
          
          git commit -m "Auto-update: ${{ env.BASE_VERSION }}-${{ steps.date.outputs.date }}"
          
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯
          git push

      # åˆ›å»º Release (æ ¼å¼: va.b-yyyymmdd)
      - name: Create Release
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: softprops/action-gh-release@v1
        with:
          # ç‰ˆæœ¬å·ç»„åˆï¼šæ‰‹åŠ¨ç‰ˆæœ¬ + æ—¥æœŸ
          tag_name: ${{ env.BASE_VERSION }}-${{ steps.date.outputs.date }}
          name: ${{ env.BASE_VERSION }} Auto Update ${{ steps.date.outputs.date }}
          body: |
            è‡ªåŠ¨æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ã€‚
            
            - **Base Version**: ${{ env.BASE_VERSION }}
            - **Update Date**: ${{ steps.date.outputs.date }}
            - **Updated Files**: `output/students_data.csv`, `output/skipped_ids.csv`
          files: |
            output/students_data.csv
            output/skipped_ids.csv
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}